// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © trading-scripts-library

//@version=6
strategy("Bollinger Bands Breakout Strategy",
     overlay=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_type=strategy.commission.percent,
     commission_value=0.1)

// ══════════════════════════════════════════════════════════════════════════════
// DESCRIPTION
// A volatility breakout strategy using Bollinger Bands with volume confirmation.
// - Long entry: Price closes above upper band + volume spike
// - Long exit: Price touches middle band OR trailing stop hit
// - Short entry: Price closes below lower band + volume spike
// - Short exit: Price touches middle band OR trailing stop hit
// Best for trending markets with clear breakout patterns.
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────────────────────────────────────────────────────────────────
// INPUTS
// ─────────────────────────────────────────────────────────────────────────────
group_bb = "Bollinger Bands Settings"
bbLength = input.int(20, "BB Length", minval=1, group=group_bb)
bbMult = input.float(2.0, "BB Std Dev Multiplier", minval=0.1, step=0.1, group=group_bb)
bbSource = input.source(close, "BB Source", group=group_bb)

group_vol = "Volume Confirmation"
useVolumeFilter = input.bool(true, "Require Volume Confirmation", group=group_vol)
volumeMALength = input.int(20, "Volume MA Length", minval=1, group=group_vol)
volumeMultiplier = input.float(1.5, "Volume Spike Multiplier", minval=1.0, step=0.1, group=group_vol)

group_risk = "Risk Management"
useTrailingStop = input.bool(true, "Use Trailing Stop", group=group_risk)
trailingStopPercent = input.float(2.0, "Trailing Stop %", minval=0.1, step=0.1, group=group_risk)
exitOnMiddleBand = input.bool(true, "Exit on Middle Band Touch", group=group_risk)

group_trade = "Trade Settings"
allowShorts = input.bool(true, "Allow Short Trades", group=group_trade)
requireCloseOutside = input.bool(true, "Require Close Outside Band", group=group_trade)

// ─────────────────────────────────────────────────────────────────────────────
// CALCULATIONS
// ─────────────────────────────────────────────────────────────────────────────
// Bollinger Bands
basis = ta.sma(bbSource, bbLength)
dev = bbMult * ta.stdev(bbSource, bbLength)
upperBand = basis + dev
lowerBand = basis - dev

// Band width for volatility analysis
bandWidth = (upperBand - lowerBand) / basis * 100

// Volume analysis
volumeMA = ta.sma(volume, volumeMALength)
volumeSpike = volume > volumeMA * volumeMultiplier
highVolume = not useVolumeFilter or volumeSpike

// Breakout detection
closeAboveUpper = requireCloseOutside ? close > upperBand : high > upperBand
closeBelowLower = requireCloseOutside ? close < lowerBand : low < lowerBand

// Middle band touch
touchedMiddle = low <= basis and high >= basis

// ─────────────────────────────────────────────────────────────────────────────
// ENTRY/EXIT CONDITIONS
// ─────────────────────────────────────────────────────────────────────────────
longCondition = closeAboveUpper and highVolume
shortCondition = closeBelowLower and highVolume and allowShorts

longExitCondition = exitOnMiddleBand and touchedMiddle and strategy.position_size > 0
shortExitCondition = exitOnMiddleBand and touchedMiddle and strategy.position_size < 0

// ─────────────────────────────────────────────────────────────────────────────
// STRATEGY EXECUTION
// ─────────────────────────────────────────────────────────────────────────────
if longCondition
    strategy.entry("Long", strategy.long)

if shortCondition
    strategy.entry("Short", strategy.short)

// Trailing stop management
if strategy.position_size > 0 and useTrailingStop
    trailPrice = close * (1 - trailingStopPercent/100)
    strategy.exit("Long Trail", "Long", trail_price=trailPrice, trail_offset=close * trailingStopPercent/100 / syminfo.mintick)

if strategy.position_size < 0 and useTrailingStop
    trailPrice = close * (1 + trailingStopPercent/100)
    strategy.exit("Short Trail", "Short", trail_price=trailPrice, trail_offset=close * trailingStopPercent/100 / syminfo.mintick)

// Middle band exits
if longExitCondition
    strategy.close("Long", comment="Middle Band")

if shortExitCondition
    strategy.close("Short", comment="Middle Band")

// ─────────────────────────────────────────────────────────────────────────────
// PLOTTING
// ─────────────────────────────────────────────────────────────────────────────
// Bollinger Bands
upperPlot = plot(upperBand, "Upper Band", color=color.new(color.red, 0), linewidth=1)
basisPlot = plot(basis, "Middle Band", color=color.new(color.blue, 0), linewidth=2)
lowerPlot = plot(lowerBand, "Lower Band", color=color.new(color.green, 0), linewidth=1)

// Band fill
fill(upperPlot, basisPlot, color=color.new(color.red, 90))
fill(basisPlot, lowerPlot, color=color.new(color.green, 90))

// Signal markers
plotshape(longCondition, "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.normal)
plotshape(shortCondition, "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.normal)

// Volume spike indicator
plotshape(volumeSpike and (closeAboveUpper or closeBelowLower), "Volume Spike", shape.circle, location.top, color.new(color.yellow, 0), size=size.tiny)

// Breakout background
bgcolor(closeAboveUpper and highVolume ? color.new(color.green, 85) : closeBelowLower and highVolume ? color.new(color.red, 85) : na)

// ─────────────────────────────────────────────────────────────────────────────
// ALERTS
// ─────────────────────────────────────────────────────────────────────────────
alertcondition(longCondition, "BB Long Breakout", "Bollinger Breakout: Price broke above upper band with volume")
alertcondition(shortCondition, "BB Short Breakout", "Bollinger Breakout: Price broke below lower band with volume")
alertcondition(longExitCondition, "BB Long Exit", "Bollinger Breakout: Price returned to middle band (long exit)")
alertcondition(shortExitCondition, "BB Short Exit", "Bollinger Breakout: Price returned to middle band (short exit)")

// ─────────────────────────────────────────────────────────────────────────────
// INFO TABLE
// ─────────────────────────────────────────────────────────────────────────────
var table infoTable = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))

if barstate.islast
    table.cell(infoTable, 0, 0, "Band Width", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(bandWidth, "#.##") + "%", text_color=color.white)
    table.cell(infoTable, 0, 1, "Volume", text_color=color.white)
    table.cell(infoTable, 1, 1, volumeSpike ? "HIGH" : "NORMAL", text_color=volumeSpike ? color.yellow : color.gray)
    table.cell(infoTable, 0, 2, "Price Zone", text_color=color.white)
    table.cell(infoTable, 1, 2, close > upperBand ? "ABOVE" : close < lowerBand ? "BELOW" : "INSIDE",
         text_color=close > upperBand ? color.green : close < lowerBand ? color.red : color.gray)
    table.cell(infoTable, 0, 3, "Position", text_color=color.white)
    table.cell(infoTable, 1, 3, strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "FLAT",
         text_color=strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray)
